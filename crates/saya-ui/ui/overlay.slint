import { VerticalBox, HorizontalBox, ScrollView, Button } from "std-widgets.slint";
import { ConfigPanel } from "components/config.slint";

export struct DictResult {
    term: string,
    reading: string,
    definition: string,
    frequency: string,
    pitch_accent: string,
    jlpt_level: string,
    conjugation: string,
}

export struct RawTextEntry {
    text: string,
    source: string,
    timestamp: string,
}

export component OverlayWindow inherits Window {
    title: "Saya";
    always-on-top: true;

    in-out property <[DictResult]> results: [];
    in-out property <string> hooked-text: "";
    in-out property <string> text-source: "";
    in-out property <string> translation: "";
    in-out property <bool> config-visible: false;
    in-out property <bool> ocr-auto-mode: false;
    callback add-to-anki(int);
    callback show-config();
    callback toggle-ocr-auto();
    callback trigger-ocr-capture();

    // Dynamic sizing based on content
    min-width: 400px;
    max-width: 800px;
    min-height: 200px;
    max-height: 900px;

    // Glassmorphic background
    background: #0f0f0fF0;

    VerticalBox {
        padding: 16px;
        spacing: 16px;

        // Header control bar
        Rectangle {
            height: 48px;
            background: #1a1a1aF5;
            border-radius: 8px;
            border-width: 1px;
            border-color: #333333;

            HorizontalBox {
                padding: 12px;
                spacing: 16px;
                alignment: center;

                // Settings button
                TouchArea {
                    width: 100px;
                    height: 32px;
                    clicked => { root.show-config(); }

                    Rectangle {
                        background: #2a2a2a;
                        border-radius: 6px;
                        border-width: 2px;
                        border-color: #00ff88;

                        HorizontalBox {
                            padding: 8px;
                            spacing: 6px;
                            alignment: center;

                            Text {
                                text: "⚙";
                                font-size: 16px;
                                color: #00ff88;
                            }

                            Text {
                                text: "Settings";
                                font-size: 13px;
                                color: #00ff88;
                                font-weight: 600;
                            }
                        }
                    }
                }

                // Divider
                Rectangle {
                    width: 2px;
                    height: 24px;
                    background: #444444;
                }

                // OCR Label
                Text {
                    text: "OCR:";
                    font-size: 14px;
                    color: #b0b0b0;
                    font-weight: 600;
                    vertical-alignment: center;
                }

                // AUTO/MANUAL toggle (improved visibility)
                TouchArea {
                    width: 80px;
                    height: 32px;
                    clicked => { root.toggle-ocr-auto(); }

                    Rectangle {
                        background: ocr-auto-mode ? #00ff8844 : #44444444;
                        border-radius: 16px;
                        border-width: 2px;
                        border-color: ocr-auto-mode ? #00ff88 : #888888;

                        Text {
                            text: ocr-auto-mode ? "AUTO" : "MANUAL";
                            font-size: 11px;
                            font-weight: 800;
                            color: ocr-auto-mode ? #ffffff : #cccccc;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }

                // Capture / Stop button
                TouchArea {
                    width: 110px;
                    height: 32px;
                    clicked => { root.trigger-ocr-capture(); }

                    Rectangle {
                        background: ocr-auto-mode ? #ff444444 : #00ff8844;
                        border-radius: 6px;
                        border-width: 2px;
                        border-color: ocr-auto-mode ? #ff4444 : #00ff88;

                        Text {
                            text: ocr-auto-mode ? "Stop Auto" : "Capture Now";
                            font-size: 12px;
                            font-weight: 700;
                            color: #ffffff;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }
            }
        }

        // Top Section: Hooked Text Display (if exists)
        if hooked-text != "": Rectangle {
            background: #1a1a1aF5;
            border-radius: 12px;
            border-width: 1px;
            border-color: #333333;
            drop-shadow-blur: 16px;
            drop-shadow-color: #00000066;
            drop-shadow-offset-y: 4px;

            VerticalBox {
                padding: 20px;
                spacing: 12px;

                // Source badge
                HorizontalBox {
                    height: 20px;
                    spacing: 8px;

                    Rectangle {
                        width: 10px;
                        height: 10px;
                        border-radius: 5px;
                        background: text-source == "OCR" ? #ff6b6b :
                                   text-source == "Clipboard" ? #4ecdc4 :
                                   text-source == "WebSocket" ? #a29bfe :
                                   #95a5a6;
                        drop-shadow-blur: 4px;
                        drop-shadow-color: text-source == "OCR" ? #ff6b6b66 :
                                          text-source == "Clipboard" ? #4ecdc466 :
                                          text-source == "WebSocket" ? #a29bfe66 :
                                          #95a5a666;
                    }

                    Text {
                        text: text-source;
                        font-size: 12px;
                        color: #b0b0b0;
                        font-weight: 600;
                        letter-spacing: 0.5px;
                    }
                }

                // Main hooked text - large, prominent
                Text {
                    text: hooked-text;
                    font-size: 28px;
                    color: #ffffff;
                    font-weight: 600;
                    wrap: word-wrap;
                    horizontal-alignment: left;
                }

                // Translation (if exists)
                if translation != "": Rectangle {
                    background: #0d2a1eCC;
                    border-radius: 8px;
                    border-width: 1px;
                    border-color: #00ff8833;

                    HorizontalBox {
                        padding: 12px;
                        spacing: 10px;

                        Text {
                            text: "→";
                            font-size: 18px;
                            color: #00ff88;
                            vertical-alignment: center;
                        }

                        Text {
                            text: translation;
                            font-size: 16px;
                            color: #c0f0d0;
                            wrap: word-wrap;
                        }
                    }
                }
            }
        }

        // Dictionary Results Section
        if results.length > 0: ScrollView {
            vertical-stretch: 1;

            VerticalBox {
                spacing: 12px;
                padding: 4px;

                for result[idx] in results: Rectangle {
                    background: #1a1a1aF5;
                    border-radius: 12px;
                    border-width: 1px;
                    border-color: #333333;
                    drop-shadow-blur: 12px;
                    drop-shadow-color: #00000044;
                    drop-shadow-offset-y: 2px;

                    VerticalBox {
                        padding: 20px;
                        spacing: 12px;

                        // Header: Term + Anki Button
                        HorizontalBox {
                            spacing: 12px;

                            Text {
                                text: result.term;
                                font-size: 24px;
                                color: #ffffff;
                                font-weight: 700;
                                horizontal-stretch: 1;
                            }

                            Button {
                                text: "+ Anki";
                                primary: true;
                                clicked => {
                                    root.add-to-anki(idx);
                                }
                            }
                        }

                        // Reading (pronunciation)
                        if result.reading != "": Text {
                            text: result.reading;
                            font-size: 16px;
                            color: #b0b0b0;
                            font-italic: true;
                        }

                        // Metadata Pills (frequency, pitch, JLPT)
                        if result.frequency != "" || result.pitch_accent != "" || result.jlpt_level != "": HorizontalBox {
                            spacing: 8px;

                            if result.frequency != "": Rectangle {
                                background: #ffd70022;
                                border-radius: 12px;
                                border-width: 1px;
                                border-color: #ffd70044;
                                height: 24px;

                                HorizontalBox {
                                    padding-left: 10px;
                                    padding-right: 10px;
                                    alignment: center;

                                    Text {
                                        text: result.frequency;
                                        font-size: 12px;
                                        color: #ffd700;
                                        font-weight: 600;
                                    }
                                }
                            }

                            if result.pitch_accent != "": Rectangle {
                                background: #87ceeb22;
                                border-radius: 12px;
                                border-width: 1px;
                                border-color: #87ceeb44;
                                height: 24px;

                                HorizontalBox {
                                    padding-left: 10px;
                                    padding-right: 10px;
                                    alignment: center;

                                    Text {
                                        text: result.pitch_accent;
                                        font-size: 12px;
                                        color: #87ceeb;
                                        font-weight: 600;
                                    }
                                }
                            }

                            if result.jlpt_level != "": Rectangle {
                                background: #98fb9822;
                                border-radius: 12px;
                                border-width: 1px;
                                border-color: #98fb9844;
                                height: 24px;

                                HorizontalBox {
                                    padding-left: 10px;
                                    padding-right: 10px;
                                    alignment: center;

                                    Text {
                                        text: result.jlpt_level;
                                        font-size: 12px;
                                        color: #98fb98;
                                        font-weight: 600;
                                    }
                                }
                            }
                        }

                        // Conjugation info
                        if result.conjugation != "": Rectangle {
                            background: #24242488;
                            border-radius: 6px;

                            HorizontalBox {
                                padding: 8px;

                                Text {
                                    text: result.conjugation;
                                    font-size: 13px;
                                    color: #b0b0b0;
                                    font-italic: true;
                                    wrap: word-wrap;
                                }
                            }
                        }

                        // Divider
                        Rectangle {
                            height: 1px;
                            background: #333333;
                        }

                        // Definition - most important, give it space
                        Text {
                            text: result.definition;
                            font-size: 16px;
                            color: #e0e0e0;
                            wrap: word-wrap;
                        }
                    }
                }
            }
        }

        // Empty state (when no results)
        if results.length == 0 && hooked-text == "": Rectangle {
            background: transparent;
            vertical-stretch: 1;

            VerticalBox {
                alignment: center;
                spacing: 16px;

                Text {
                    text: "No results yet";
                    font-size: 18px;
                    color: #606060;
                    horizontal-alignment: center;
                }

                Text {
                    text: "Capture text or use OCR to see results";
                    font-size: 14px;
                    color: #404040;
                    horizontal-alignment: center;
                }
            }
        }
    }

    // Config overlay (modal on top of everything)
    if config-visible: Rectangle {
        // Full-screen overlay backdrop
        background: #000000CC;
        z: 100;
        width: root.width;
        height: root.height;

        TouchArea {
            width: parent.width;
            height: parent.height;
            clicked => { root.config-visible = false; }  // Close on backdrop click
        }

        // Centered config panel
        Rectangle {
            width: 700px;
            height: 600px;
            background: #0f0f0fF5;
            border-radius: 12px;
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            drop-shadow-blur: 24px;
            drop-shadow-color: #00000088;

            TouchArea {
                width: parent.width;
                height: parent.height;
                // Stop clicks from closing the config when clicking inside panel
            }

            ConfigPanel {
                width: parent.width;
                height: parent.height;
                close-panel => { root.config-visible = false; }
            }
        }
    }
}
