import { VerticalBox, HorizontalBox, Button } from "std-widgets.slint";

export component OcrWindow inherits Window {
    title: "OCR Capture";
    always-on-top: true;
    no-frame: true;

    callback capture-clicked();
    callback refresh-windows();
    callback window-selected(int);
    callback toggle-auto-mode();
    callback window-resized();
    callback window-closed();

    in-out property<string> status: "Initializing...";
    in-out property<bool> is-capturing: false;
    in-out property<bool> is-ready: false;
    in-out property<bool> auto-capturing-mode: false;
    in-out property<[string]> window-list: [];
    in-out property<int> selected-window-index: -1;
    in-out property<color> border-ready-color: #00ff88;
    in-out property<color> border-capturing-color: #ff4444;
    in-out property<color> border-preparing-color: #ffaa00;

    function button_text() -> string {
        if (!is-ready) {
            return "Preparing...";
        }

        if (is-capturing) {
            return "Capturing...";
        }

        if (auto-capturing-mode) {
            return "Auto OCR Active";
        }

        return "Capture Once";
    }

    min-width: 200px;
    min-height: 100px;

    background: transparent;

    // Main container with dragging support
    Rectangle {
        background: transparent;
        border-width: 1px;
        border-color: is-capturing ? border-capturing-color : is-ready ? border-ready-color : border-preparing-color;
        border-radius: 8px;

        VerticalBox {
            padding: 0px;
            spacing: 0px;

            // Draggable header area with close button
            Rectangle {
                height: 32px;
                background: transparent;

                HorizontalLayout {
                    padding: 4px;

                    // Draggable area (takes most space)
                    TouchArea {
                        horizontal-stretch: 1;
                        mouse-cursor: move;

                        moved => {
                            if (self.pressed) {
                                root.x += self.mouse-x - self.pressed-x;
                                root.y += self.mouse-y - self.pressed-y;
                            }
                        }
                    }

                    // Close button (top-right)
                    TouchArea {
                        width: 28px;
                        height: 28px;
                        clicked => { root.window-closed(); }

                        Rectangle {
                            background: #ff4444;
                            border-radius: 4px;
                            border-width: 2px;
                            border-color: #ffffff;

                            Text {
                                text: "âœ•";
                                font-size: 16px;
                                color: #ffffff;
                                font-weight: 900;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }
                    }
                }
            }

            // Visual capture area (the green/red bordered zone)
            Rectangle {
                background: transparent;
                vertical-stretch: 1;
                min-height: 60px;
            }
        }

        // Resize handles (4 corners)
        // Bottom-right resize handle
        TouchArea {
            width: 16px;
            height: 16px;
            x: parent.width - 16px;
            y: parent.height - 16px;
            mouse-cursor: nwse-resize;

            moved => {
                if (self.pressed) {
                    root.width = max(root.min-width, root.width + self.mouse-x - self.pressed-x);
                    root.height = max(root.min-height, root.height + self.mouse-y - self.pressed-y);
                    root.window-resized();
                }
            }

            Rectangle {
                background: #00ff88;
                border-radius: 2px;
            }
        }

        // Bottom-left resize handle
        TouchArea {
            width: 16px;
            height: 16px;
            x: 0px;
            y: parent.height - 16px;
            mouse-cursor: nesw-resize;

            moved => {
                if (self.pressed) {
                    let delta-x = self.mouse-x - self.pressed-x;
                    let new-width = max(root.min-width, root.width - delta-x);
                    if (new-width > root.min-width) {
                        root.x += delta-x;
                        root.width = new-width;
                    }
                    root.height = max(root.min-height, root.height + self.mouse-y - self.pressed-y);
                    root.window-resized();
                }
            }

            Rectangle {
                background: #00ff88;
                border-radius: 2px;
            }
        }

        // Top-right resize handle
        TouchArea {
            width: 16px;
            height: 16px;
            x: parent.width - 16px;
            y: 0px;
            mouse-cursor: nesw-resize;

            moved => {
                if (self.pressed) {
                    let delta-y = self.mouse-y - self.pressed-y;
                    let new-height = max(root.min-height, root.height - delta-y);
                    if (new-height > root.min-height) {
                        root.y += delta-y;
                        root.height = new-height;
                    }
                    root.width = max(root.min-width, root.width + self.mouse-x - self.pressed-x);
                    root.window-resized();
                }
            }

            Rectangle {
                background: #00ff88;
                border-radius: 2px;
            }
        }

        // Top-left resize handle
        TouchArea {
            width: 16px;
            height: 16px;
            x: 0px;
            y: 0px;
            mouse-cursor: nwse-resize;

            moved => {
                if (self.pressed) {
                    let delta-x = self.mouse-x - self.pressed-x;
                    let delta-y = self.mouse-y - self.pressed-y;
                    let new-width = max(root.min-width, root.width - delta-x);
                    let new-height = max(root.min-height, root.height - delta-y);
                    if (new-width > root.min-width) {
                        root.x += delta-x;
                        root.width = new-width;
                    }
                    if (new-height > root.min-height) {
                        root.y += delta-y;
                        root.height = new-height;
                    }
                    root.window-resized();
                }
            }

            Rectangle {
                background: #00ff88;
                border-radius: 2px;
            }
        }
    }
}
