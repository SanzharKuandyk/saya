import { VerticalBox, HorizontalBox, Button } from "std-widgets.slint";

export component OcrWindow inherits Window {
    title: "OCR Capture";
    always-on-top: true;
    no-frame: true;

    callback capture-clicked();
    callback refresh-windows();
    callback window-selected(int);
    callback toggle-auto-mode();
    callback window-resized();

    in-out property<string> status: "Initializing...";
    in-out property<bool> is-capturing: false;
    in-out property<bool> is-ready: false;
    in-out property<bool> auto-capturing-mode: false;
    in-out property<[string]> window-list: [];
    in-out property<int> selected-window-index: -1;

    function button_text() -> string {
        if (!is-ready) {
            return "Preparing...";
        }

        if (is-capturing) {
            return "Capturing...";
        }

        if (auto-capturing-mode) {
            return "Auto OCR Active";
        }

        return "Capture Once";
    }

    min-width: 200px;
    min-height: 100px;

    background: transparent;

    // Main container with dragging support
    Rectangle {
        background: transparent;
        border-width: 3px;
        border-color: is-capturing ? #ff4444 : is-ready ? #00ff88 : #ffaa00;
        border-radius: 8px;

        // Glow effect for better visibility
        drop-shadow-blur: 8px;
        drop-shadow-color: is-capturing ? #ff444444 : is-ready ? #00ff8844 : #ffaa0044;
        drop-shadow-offset-x: 0px;
        drop-shadow-offset-y: 0px;

        VerticalBox {
            padding: 0px;
            spacing: 0px;

            // Draggable header area (invisible but functional)
            TouchArea {
                height: 32px;
                mouse-cursor: move;

                moved => {
                    if (self.pressed) {
                        root.x += self.mouse-x - self.pressed-x;
                        root.y += self.mouse-y - self.pressed-y;
                    }
                }
            }

            // Visual capture area (the green/red bordered zone)
            Rectangle {
                background: transparent;
                vertical-stretch: 1;
                min-height: 60px;
            }

            // Bottom control strip (ALWAYS VISIBLE)
            Rectangle {
                background: #0f0f0fDD;
                height: 40px;
                border-bottom-left-radius: 6px;
                border-bottom-right-radius: 6px;

                HorizontalBox {
                    padding: 8px;
                    spacing: 8px;
                    alignment: center;

                    // Auto toggle button
                    TouchArea {
                        width: 60px;
                        height: 28px;
                        clicked => { root.toggle-auto-mode(); }

                        Rectangle {
                            background: auto-capturing-mode ? #00ff8833 : #33333333;
                            border-radius: 14px;
                            border-width: 1px;
                            border-color: auto-capturing-mode ? #00ff88 : #666666;

                            Text {
                                text: auto-capturing-mode ? "AUTO" : "MANUAL";
                                font-size: 10px;
                                font-weight: 700;
                                color: auto-capturing-mode ? #00ff88 : #999999;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }
                    }

                    // Capture button (only enabled in manual mode)
                    Button {
                        text: button_text();
                        enabled: is-ready && !is-capturing && !auto-capturing-mode;
                        clicked => capture-clicked();
                    }
                }
            }
        }

        // Resize handles (4 corners)
        // Bottom-right resize handle
        TouchArea {
            width: 16px;
            height: 16px;
            x: parent.width - 16px;
            y: parent.height - 16px;
            mouse-cursor: nwse-resize;

            moved => {
                if (self.pressed) {
                    root.width = max(root.min-width, root.width + self.mouse-x - self.pressed-x);
                    root.height = max(root.min-height, root.height + self.mouse-y - self.pressed-y);
                    root.window-resized();
                }
            }

            Rectangle {
                background: #00ff88;
                border-radius: 2px;
            }
        }

        // Bottom-left resize handle
        TouchArea {
            width: 16px;
            height: 16px;
            x: 0px;
            y: parent.height - 16px;
            mouse-cursor: nesw-resize;

            moved => {
                if (self.pressed) {
                    let delta-x = self.mouse-x - self.pressed-x;
                    let new-width = max(root.min-width, root.width - delta-x);
                    if (new-width > root.min-width) {
                        root.x += delta-x;
                        root.width = new-width;
                    }
                    root.height = max(root.min-height, root.height + self.mouse-y - self.pressed-y);
                    root.window-resized();
                }
            }

            Rectangle {
                background: #00ff88;
                border-radius: 2px;
            }
        }

        // Top-right resize handle
        TouchArea {
            width: 16px;
            height: 16px;
            x: parent.width - 16px;
            y: 0px;
            mouse-cursor: nesw-resize;

            moved => {
                if (self.pressed) {
                    let delta-y = self.mouse-y - self.pressed-y;
                    let new-height = max(root.min-height, root.height - delta-y);
                    if (new-height > root.min-height) {
                        root.y += delta-y;
                        root.height = new-height;
                    }
                    root.width = max(root.min-width, root.width + self.mouse-x - self.pressed-x);
                    root.window-resized();
                }
            }

            Rectangle {
                background: #00ff88;
                border-radius: 2px;
            }
        }

        // Top-left resize handle
        TouchArea {
            width: 16px;
            height: 16px;
            x: 0px;
            y: 0px;
            mouse-cursor: nwse-resize;

            moved => {
                if (self.pressed) {
                    let delta-x = self.mouse-x - self.pressed-x;
                    let delta-y = self.mouse-y - self.pressed-y;
                    let new-width = max(root.min-width, root.width - delta-x);
                    let new-height = max(root.min-height, root.height - delta-y);
                    if (new-width > root.min-width) {
                        root.x += delta-x;
                        root.width = new-width;
                    }
                    if (new-height > root.min-height) {
                        root.y += delta-y;
                        root.height = new-height;
                    }
                    root.window-resized();
                }
            }

            Rectangle {
                background: #00ff88;
                border-radius: 2px;
            }
        }
    }
}
